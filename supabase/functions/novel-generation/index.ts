
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import "https://deno.land/x/xhr@0.1.0/mod.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

// 預設小說章節內容庫
const predefinedChapters: Record<number, string> = {
  8: `第八章：最後的反擊

安德森教授的辦公室裡，氣氛凝重。電腦螢幕上顯示著曙光計劃的最新數據，而我和莉娜·趙博士正在向他和馬庫斯·韋恩展示我們的模擬結果。

「根據這些數據，」我指向螢幕上的紅色警告區域，「如果按原計劃進行全功率測試，亞空間撕裂將在第一小時內就擴散到整個實驗設施，48小時內波及全球。」

馬庫斯臉色蒼白：「這比我們最壞的預想還要糟。」

「問題是，」安德森教授長嘆一口氣，「霍夫已經獲得了所有必要授權。測試將在三天後進行，即使是我也無法單獨阻止它。」

「那麼我們需要更多支持，」莉娜堅定地說，「科學委員會必須看到這些數據。」

「科學委員會由霍夫控制，」馬庫斯搖頭，「他們不會冒險推遲測試。全球能源儲備即將枯竭，政治壓力太大了。」

我從背包中拿出神秘人給我的量子場穩定器：「還有一個選項。這個裝置可以在小範圍內穩定亞空間。如果我們能在測試前將它安裝在核心反應堆附近，至少可以爭取時間來說服其他人。」

「這是什麼技術？」安德森好奇地檢視著裝置，「我從未見過這樣的設計。」

「這不重要，」我避開他的問題，「重要的是它有效。但我們需要進入核心設施的許可。」

安德森和馬庫斯交換了一個眼神。「我可以安排，」馬庫斯最終說道，「但必須非常小心。如果被霍夫發現...」

「我願意冒這個險，」我堅定地說，「畢竟，我已經見證過一次世界末日了。」

隨後兩天，我們秘密準備行動計劃。莉娜和馬庫斯負責創建一個技術報告，證明測試可以在更安全的參數下進行。安德森則安排我們進入設施的許可。而我，則研究如何最有效地部署量子場穩定器。

行動當天，我和莉娜偽裝成技術人員進入了設施。在馬庫斯的遠程指導下，我們順利到達了核心反應堆附近。

「快，」莉娜緊張地看著手錶，「安德森只能保證我們20分鐘不被監控系統發現。」

我迅速打開設備面板，尋找最佳安裝點。就在這時，身後傳來了腳步聲。

「我就知道會有人試圖破壞測試。」

我們轉身，看到塞巴斯蒂安·霍夫站在那裡，身旁是兩名保安。

「霍夫先生，」我盡量保持鎮定，「我們不是來破壞的，而是來拯救的。這個測試會導致災難性後果，我們有確鑿的證據。」

「所謂的證據，」霍夫不屑一顧，「不過是基於錯誤假設的模擬結果。世界需要曙光計劃，現在就需要！」

「那麼至少看看我們的報告，」莉娜懇求道，「推遲一周進行更多測試。如果我們是錯的，你只損失七天時間；如果我們是對的，你將拯救全世界。」

霍夫沉默片刻，似乎在考慮。但最終，他搖了搖頭：「安全！帶走他們。」

就在保安上前的一瞬間，整個設施突然警報大作，燈光閃爍。

「發生什麼了？」霍夫驚訝地問。

一個聲音從廣播系統中傳來——是安德森教授：「全體人員注意，由於發現系統中的關鍵安全漏洞，曙光計劃測試將推遲至下周。此為最高級別指令，所有人員立即撤離核心設施進行安全檢查。」

霍夫的臉因憤怒而扭曲：「這不可能！他沒有權限...」

他匆忙離開去確認情況，留下困惑的保安。我趁機迅速安裝了量子場穩定器。

「成功了，」我對莉娜低語，「但這只是開始。我們還需要徹底修改曙光計劃的核心算法。」

莉娜點點頭：「有了這一周的時間和安德森教授的支持，我們可以做到。」

當我們離開設施時，我收到了神秘人的信息：「時間線已經改變。繼續努力，你們已經開始重寫未來。」

我看向天空，想著一個月前那個末日的景象。現在，至少我們有了希望。我們的反擊，才剛剛開始。`,

  9: `第九章：真相與背叛

獲得一週寶貴時間後，我們立即進入曙光計劃的核心實驗室，開始全面分析和重寫核心算法。莉娜的量子物理知識與我從未來帶回的信息完美結合，使得工作進展迅速。

「這些修改應該能將亞空間撕裂風險降低到可接受水平，」莉娜指著我們的新模型說。安德森教授和馬庫斯仔細查看著數據，表情嚴肅但帶著希望。

然而，第三天清晨，一切突然發生變化。我被緊急召喚到安德森的辦公室，發現他面色凝重。

「出事了，」他直接說道，「霍夫不僅沒有停止準備工作，反而提前了測試時間。就在明天。」

「什麼？」我震驚地問，「他怎麼能繞過你的權限？」

「國際能源聯盟緊急會議批准了他的請求。他聲稱我的決定是基於『未經證實的恐慌』，並提供了自己的專家意見證明曙光計劃完全安全。」

我感到一陣寒意：「我們沒有足夠時間完成所有修改。量子場穩定器能延緩災難，但不能完全阻止它。」

安德森的電腦突然收到一封加密郵件。是馬庫斯發來的：「緊急情況。霍夫的人正在搜尋李明和莉娜。我認為你們的身份已經暴露。立即離開大學。」

「我們必須拿到完整的曙光計劃源代碼，」我迅速決定，「在外部完成修改，然後想辦法在測試前替換它。」

「這幾乎是不可能的，」安德森搖頭，「源代碼存儲在高度安全的服務器上，需要三重生物認證。」

就在這時，辦公室門突然打開，莉娜衝了進來，神情慌張：「他們抓住了馬庫斯！霍夫的人到處都是！」

安德森立即行動：「跟我來，有一條秘密通道。」他帶領我們穿過一個隱藏在書架後的小門，進入了一條狹窄的走廊。

「這會帶你們到校園外的安全地點，」他遞給我一個加密硬盤，「這裡是曙光計劃的部分源代碼，不完整，但比沒有好。現在快走！」

「那你呢？」我擔憂地問。

「我必須留下來爭取時間，維持我的權威形象。霍夫不敢直接對抗我，至少短時間內不會。」安德森推著我們向前，「記住，如果曙光計劃以當前形式啟動，後果將不可挽回。」

我們狼狽地逃到校外，找了一家小旅館暫時藏身。莉娜立即開始分析硬盤內容，我則聯繫神秘人尋求援助。

「情況緊急，」我在加密通訊中寫道，「曙光計劃測試提前到明天，我們需要完整源代碼。」

回覆很快就來了：「已知悉。去城郊廢棄工廠，有人會給你們需要的東西。小心行事，霍夫的人正在全城搜尋。」

夜幕降臨時，我和莉娜偽裝後悄悄前往指定地點。廢棄工廠陰森可怖，唯一的聲音是遠處工業區的隱約轟鳴。

「你確定這是正確的地方？」莉娜緊張地低聲問。

就在這時，黑暗中走出一個熟悉的身影——是神秘人！但讓我震驚的是，他身旁站著另一個人：塞巴斯蒂安·霍夫。

「這是什麼情況？」我警惕地後退一步，準備隨時逃跑。

「別緊張，李明，」神秘人舉起手示意，「事情比你想像的複雜得多。」

霍夫上前一步：「我知道你不信任我，但請聽我解釋。我一直在秘密監控曙光計劃真正的危險，而這危險不僅來自技術本身。」

「什麼意思？」

「曙光計劃的初衷是解決能源危機，但有人在背後操控，利用它製造一個可控的小型災難，以此獲取重建後的巨大利益。」他遞給我一個數據板，「這些是真實的內部文件。」

我快速瀏覽文件，驚訝地發現霍夫一直在調查的是一個名為「新曙光財團」的神祕組織，他們計劃利用曙光項目製造有限範圍的災難，然後通過預先準備的技術「拯救」世界，從而獲得前所未有的政治和經濟控制權。

「這就是為什麼我必須表現得極力支持項目，」霍夫解釋，「以獲得他們的信任，進入核心圈子。」

「那安德森教授...」

「他很可能是無意識的參與者，」霍夫嚴肅地說，「但我不能確定。現在我們必須合作，不僅要修改算法防止全球災難，還要揭露這個陰謀。」

我看向神秘人，他點頭確認：「我們的組織在多個時間線中追蹤這個模式。新曙光財團總是出現，利用各種危機謀取利益。這是改變歷史的關鍵點。」

我和莉娜對視一眼，意識到事情比我們想像的更加複雜。這不再只是防止一場物理災難，而是阻止一個精心策劃的陰謀。

「好吧，」我最終決定，「我們該怎麼做？」

霍夫露出了第一個真誠的微笑：「我有一個計劃，但需要你們的量子物理知識和未來技術。明天的測試將按計劃進行，但結果將與任何人預期的都不同...」

當我們詳細討論計劃時，我意識到命運的諷刺——我最初認為的敵人，可能是最重要的盟友；而那些看似友好的面孔背後，可能隱藏著最危險的背叛。末日倒計時仍在繼續，但現在我們知道了真正應該對抗的是誰。`,

  10: `第十章：決戰時刻

測試日的清晨，霧霾籠罩整個城市，彷彿是對即將發生事件的不祥預兆。根據霍夫的計劃，我和莉娜重新獲得了進入實驗設施的許可，偽裝成技術顧問。

「記住，」霍夫通過加密通訊提醒我們，「新曙光財團的人無處不在。表現得專業但不要引人注目。在我發出信號前，不要採取行動。」

我們通過層層安檢，最終來到控制中心。巨大的屏幕上顯示著曙光計劃的實時數據，數十名技術人員忙碌地進行最後檢查。在房間中央的一張桌子旁，我看到了安德森教授，他正與幾位我不認識的人物交談。

「那就是新曙光財團的核心成員，」莉娜在我耳邊低語，「霍夫給我們的文件上有他們的照片。」

我謹慎地觀察著房間。馬庫斯被「保護性拘留」，但霍夫暗中安排他待在一個可以遠程操作的位置。神秘人則隱藏在技術人員中，準備在關鍵時刻行動。

「各位，」安德森教授突然走向中央平台，「全球能源聯盟感謝諸位的努力。今天，人類將邁出解決能源危機的關鍵一步。曙光計劃的成功，意味著無限能源的新紀元。」

台下響起掌聲。安德森繼續道：「測試將在30分鐘後開始，請各就各位。」

當人群散開時，我「不小心」撞到了安德森。「對不起，教授，」我低聲說，同時將一個微型設備滑入他的口袋，「請在私下查看這個。」

安德森略微點頭，沒有表現出認出我的樣子，但我知道他收到了信息。那個設備包含了所有關於新曙光財團陰謀的證據，以及我們修改過的安全算法。

接下來的二十分鐘，我和莉娜按計劃分頭行動，在關鍵系統節點安裝神秘人提供的量子穩定裝置。這些裝置將在測試開始後與主系統同步，形成一個量子防護網。

「倒計時15分鐘，」廣播系統宣告，「所有非必要人員請離開核心區域。」

我正準備前往最後一個安裝點，突然被一隻手抓住手臂。「李明，」一個熟悉的聲音說，「我以為你會更加小心。」

我轉身，看到財團的首領——一個在安德森身邊出現過的冷酷女性。「你的未來知識很有趣，但你真的以為能改變已經注定的結局嗎？」

她知道我的身份！我試圖掙脫，但她的手勁異常強大。「別費力了，」她微笑，「你們的小把戲我們都知道。量子穩定器？修改過的算法？多麼可愛的嘗試。但你知道嗎，有時候災難是必要的。只有通過毀滅，才能重建更強大的秩序。」

就在這危急時刻，一聲巨響從另一端傳來。霍夫啟動了分散注意力的計劃。財團首領瞬間分神，我趁機掙脱，迅速消失在走廊的人群中。

「倒計時10分鐘，」廣播繼續，「核心系統自檢中。」

我匆忙趕到最後的安裝點，卻發現莉娜已經在那裡，但她似乎在猶豫。

「怎麼了？」我焦急地問。

「這個算法...」她盯著屏幕，「它不僅僅是防止災難。如果我安裝這個量子穩定器，與修改後的算法結合，會產生一個完全不同的反應。」

「什麼反應？」

「它會永久關閉亞空間通道的可能性，」她解釋，「這意味著曙光計劃的能源轉換技術將永遠無法實現，即使是安全版本。」

我明白了她的顧慮。這不僅是阻止災難，還是放棄了解決能源危機的可能性。

「倒計時5分鐘，」廣播宣告。

「我們必須做出選擇，」我看著她的眼睛，「拯救當前的世界，還是賭一個不確定的未來？」

就在這時，安德森教授突然出現。「我看過你的證據，」他直接說，「也分析了你們的修改算法。你是對的，李明。不僅關於災難，也關於財團。」他轉向莉娜，「但你的顧慮也有道理。完全關閉亞空間研究並不是長期解決方案。」

「那我們該怎麼辦？」我急切地問。

安德森從口袋中拿出一個小型數據芯片：「這是第三種選擇。一個修改版算法，將大幅降低風險，同時保留未來研究的可能性。但必須立即安裝。」

「倒計時3分鐘。所有系統鎖定。」

我們面臨艱難選擇：霍夫和神秘人的計劃將徹底阻止災難但關閉所有可能性；安德森的方案風險較高但保留希望；或者什麼都不做，任由財團的陰謀實現。

「必須現在決定！」安德森緊急催促。

經過短暫但激烈的討論，我們選擇了安德森的方案。莉娜迅速安裝量子穩定器，我則上傳新算法。

「倒計時1分鐘。核心反應堆啟動。」

安裝完成後，我們撤離到安全區域。霍夫通過通訊表示不滿但接受了我們的決定。神秘人則警告这是一條未知的時間路徑。

「曙光計劃測試，開始。」

整個設施震動，巨大的能量波動從核心區域散發。監測屏幕上數據瘋狂跳動，一些技術人員驚慌失措。但漸漸地，波動穩定下來。

「能量轉換穩定在72%，」首席技術員報告，「亞空間通道完整性保持在安全範圍。測試...成功！」

歡呼聲響起，但被財團首領打斷：「這不可能！數據顯示能量轉換率應該達到95%！」她轉向安德森，「你做了什麼？」

安德森冷靜回應：「我選擇了安全而非貪婪。72%的轉換率足以證明技術可行，同時避免危險閾值。」

財團首領憤怒地命令：「提高功率！我要達到預定目標！」

「系統已鎖定，」技術員回應，「無法手動調整參數。」

這是我們算法的一部分——防止任何人在測試中增加危險。

隨著測試成功結束，霍夫的人同時行動，逮捕了財團核心成員。他們早已收集了足夠證據，證明財團試圖製造可控災難的陰謀。

當一切塵埃落定，我、莉娜、安德森和霍夫在一個安全地點會面。

「我們成功了，」霍夫確認，「財團的計劃已被瓦解，曙光技術被證明是可行的，只需更多安全研究。」

「那麼末日...」

「被阻止了，」安德森說，「至少這一次。」

神秘人最後一次出現，告訴我他的任務已經完成：「你已經改變了時間線。在這個版本的未來，人類文明將繼續發展。」

「那我呢？」我問，「既然未來已經改變，我該怎麼辦？」

「這就是時間悖論的美妙之處，」他神秘地笑了，「你已經成為了新時間線的一部分。你的未來，由你自己書寫。」

當他離開後，我站在窗前，看著城市的燈光。一個月前，我重生到這個時間點，帶著阻止末日的使命。現在，任務完成了，但我意識到這只是一個開始。

曙光計劃將以更安全的方式繼續，能源危機有望解決。我和莉娜被邀請加入研究團隊，而霍夫和安德森則致力於建立更透明的全球能源管理系統。

未來不再是已知的終點，而是充滿無限可能的旅程。在這個我幫助創造的新世界中，重生不再意味著拯救，而是創新。

當清晨的陽光照進窗戶，我深吸一口氣。這是新的一天，在一個被改變的時間線中——一個沒有預定末日的世界。`,
};

// 模擬生成小說章節的函數，使用預定義內容
export const generateNovelChapter = async (
  chapterNumber: number,
  previousContent?: string
): Promise<NovelChapterResponse> => {
  try {
    console.log(`正在生成第${chapterNumber}章小說內容（系統預設）`);
    
    // 檢查是否有預定義章節
    if (predefinedChapters[chapterNumber]) {
      console.log(`第${chapterNumber}章小說內容成功生成（預設內容）`);
      return {
        content: predefinedChapters[chapterNumber],
        chapterNumber: chapterNumber,
        status: 'success'
      };
    }
    
    // 如果沒有預定義章節，返回通用章節
    const genericContent = `第${chapterNumber}章：未知之旅

在末日前1個月的世界中，主角繼續尋找阻止災難的方法。系統提供了更多的能力和提示，但時間卻越來越緊迫。

在這一章中，主角發現了新的線索，或許能夠阻止即將到來的末日。然而，每一步都充滿了危險和挑戰。

幸運的是，主角在旅程中遇到了志同道合的夥伴，他們一起努力，希望能改變這個世界的命運。

無論結果如何，這段旅程已經改變了主角，讓他明白了生命的意義和真正的勇氣是什麼。`;

    console.log(`第${chapterNumber}章小說內容成功生成（通用內容）`);
    return {
      content: genericContent,
      chapterNumber: chapterNumber,
      status: 'success'
    };
  } catch (error) {
    console.error('小說生成服務錯誤:', error);
    return {
      content: '很抱歉，無法生成今天的小說章節。請稍後再試。',
      chapterNumber: chapterNumber,
      status: 'error'
    };
  }
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders })
  }

  try {
    const { chapterNumber, previousContent } = await req.json();

    // Validate input
    if (!chapterNumber || typeof chapterNumber !== 'number') {
      throw new Error("章節號碼無效");
    }

    // 使用本地預設章節內容
    const novelResponse = await generateNovelChapter(chapterNumber, previousContent);

    return new Response(JSON.stringify({ 
      content: novelResponse.content,
      chapterNumber: novelResponse.chapterNumber
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error:', error);
    return new Response(JSON.stringify({ 
      error: error.message,
      content: '很抱歉，無法生成今天的小說章節。請稍後再試。',
      chapterNumber: 0
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});
